external procedure FindRepDefHeader(string,string,var string);
remote updating function Integer CreateOPFromVI(record VIVc,var record OPVc);

global
procedure INRClassReportDefaults(Integer wn)
begin
  record RcVc RepSpec;
  record VarietyBlock Varb;
    
  BlockLoad(Varb);  
  DeselectWindow(wn,false);
  GetWindowRecord(wn,RepSpec);
  ReportDefaults(RepSpec,"INRClass");  
  RepSpec.flags[11] = 2;
  RepSpec.flags[22] = Varb.AutoVarietyDef;
  PutWindowRecord(wn,RepSpec);
  SelectWindow(wn);
  return;
end;

global
procedure BalRClassReportDefaults(Integer wn)
BEGIN
  record RcVc RepSpec;
  string 255 tstr;
  
  DeselectWindow(wn,false);
  GetWindowRecord(wn,RepSpec);
  ReportDefaults(RepSpec,"BalRClass");  
  FindRepDefHeader(RepSpec.repname,RepSpec.shortname,tstr);
  RepSpec.f1 = tstr;
  RepSpec.AccSpec = 2; //Edit***************************Sasha2,11:12 17.10.2016
  if (HasLocalization("HRV")) then begin
    RepSpec.flags[20] = 1;
  end;
  PutWindowRecord(wn,RepSpec);
  SelectWindow(wn);
  RETURN;
END;

procedure DoResRClassReportDefaults(Integer wn)
begin
  record RcVc RepSpec;
  string 255 tstr;
  
  DeselectWindow(wn,false);
  GetWindowRecord(wn,RepSpec);
  ReportDefaults(RepSpec,"ResRClass");  
  FindRepDefHeader(RepSpec.repname,RepSpec.shortname,tstr);
  RepSpec.f1 = tstr;
  RepSpec.flags[1] = 1;
  RepSpec.Stext = RepSpec.Period2Str;
  RepSpec.AccSpec = 2; //Edit***************************Sasha2,11:15 17.10.2016
  RepSpec.Comparison = 1; //Edit***************************Sasha2,11:15 17.10.2016
  PutWindowRecord(wn,RepSpec);
  SelectWindow(wn);
  return;
end;

global
procedure ResRClassReportDefaults(Integer wn)
begin
  DoResRClassReportDefaults(wn);
  return;
end;

global
updating procedure CreateOPFromVIDsm()
BEGIN
  record VIVc VIr; 
  record OPVc OPr;
  Integer wn,nwn,err;
  Integer acclevel;

  wn = CurWindow;
  acclevel = UserRegisterAccess("VIVc");
  //if (acclevel==kAccessLevelFull) or (acclevel==kAccessLevelReadNew) or (acclevel==kAccessLevelBrowseNew) then begin
    if (WindowState(wn)==Rs_normal) then begin
      GetWindowRecord(wn,VIr);     
      if (VIr.OKFlag!=0) then begin      
        err = CreateOPFromVI(VIr,OPr);
        if  (err==0) then begin
          if (MatRowCnt(OPr)>0) then begin
            nwn = OpenWindow("OPDClass",1,0,"","",OPr);
            /*if (WindowDoOK(nwn,0)) then begin
              CreateRecordLink(VIr,CurrentCompany,OPr,CurrentCompany);  
              CreateRecordLink(OPr,CurrentCompany,VIr,CurrentCompany);  
              UpdateBrowses("VIVc");
            end;*/    
          end else begin
            MessageBox(0,USetStr(22058) & " " & USetStr(50007) & " "  & USetStr(20102));
          end;   
        end else begin
          MessageBox(20802," " & USetStr(err));
        end;
      end else begin
        MessageBox(0,USetStr(50006));
      end;
    end else begin
      MessageBox(0,USetStr(1356));
    end;
  //end;
  RETURN;
END;